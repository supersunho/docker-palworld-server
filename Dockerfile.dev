# Development Dockerfile - optimized for fast iteration
FROM supersunho/steamcmd-arm64:latest

# Install development tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.12 \
    python3.12-dev \
    python3.12-venv \
    python3-pip \
    git \
    curl \
    vim \
    htop \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Python environment configuration
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONPATH="/app/src" \
    PATH="/app/.venv/bin:$PATH"

# Set working directory
WORKDIR /app

# Create Python virtual environment
RUN python3.12 -m venv .venv

# Install development dependencies
COPY requirements-dev.txt .
RUN .venv/bin/pip install --upgrade pip && \
    .venv/bin/pip install -r requirements-dev.txt

# Create application user (for development)
RUN groupadd --gid 1000 palworld && \
    useradd --uid 1000 --gid palworld --shell /bin/bash --create-home palworld

# Create directories and set permissions
RUN mkdir -p /palworld_server /backups /var/log && \
    chown -R palworld:palworld /app /palworld_server /backups /var/log

# Switch to application user
USER palworld:palworld

# Copy development entrypoint
COPY --chown=palworld:palworld scripts/entrypoint.dev.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Expose ports
EXPOSE 8211/udp 27015/udp 8212/tcp 8080/tcp

# Development entrypoint
ENTRYPOINT ["/entrypoint.sh"]
CMD ["--dev"]
